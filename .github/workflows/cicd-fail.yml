name: reusable-ci-secure

on:
  workflow_call:
    inputs:
      build_cmd:
        type: string
        required: false
        default: "echo 'TODO: build'"
      deploy_cmd:
        type: string
        required: false
        default: "echo 'TODO: deploy'"
      run_deploy:
        type: boolean
        required: false
        default: false
      sonar_project_key:
        type: string
        required: false
        default: ""
      snyk_fail_on:
        type: string
        required: false
        default: "high"
    secrets:
      SONAR_TOKEN:
        required: false
      SONAR_HOST_URL:
        required: false
      SNYK_TOKEN:
        required: false
      DEPLOY_TOKEN:
        required: false

permissions: write-all

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  prep:
    runs-on: ubuntu-latest
    outputs:
      app_name: ${{ steps.meta.outputs.app_name }}
      app_version: ${{ steps.meta.outputs.app_version }}
    steps:
      - uses: actions/checkout@v4
      - id: meta
        shell: bash
        run: |
          set -euo pipefail
          APP_NAME="${GITHUB_REPOSITORY##*/}"
          APP_VERSION="${GITHUB_SHA::7}"
          if [[ -f package.json ]]; then APP_VERSION="$(node -p "require('./package.json').version")"; fi
          echo "app_name=$APP_NAME" >> "$GITHUB_OUTPUT"
          echo "app_version=$APP_VERSION" >> "$GITHUB_OUTPUT"

  build:
    runs-on: ubuntu-latest
    needs: [prep]
    steps:
      - uses: actions/checkout@v4
      - name: Build
        shell: bash
        run: ${{ inputs.build_cmd }}

  sonar:
    runs-on: ubuntu-latest
    needs: [prep, build]
    permissions:
      contents: read
      pull-requests: read
    steps:
      - uses: actions/checkout@v4
      - name: Sonar (skip if not configured)
        shell: bash
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_PROJECT_KEY: ${{ inputs.sonar_project_key }}
        run: |
          set -x
          set -euo pipefail
          if [[ -z "${SONAR_TOKEN:-}" || -z "${SONAR_HOST_URL:-}" || -z "${SONAR_PROJECT_KEY:-}" ]]; then
            echo "Sonar not configured, skipping."
            exit 0
          fi
          echo "TODO: run sonar-scanner safely here"

  snyk:
    runs-on: ubuntu-latest
    needs: [prep, build]
    steps:
      - uses: actions/checkout@v4
      - uses: snyk/actions/setup@v2
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      - name: Snyk test
        shell: bash
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          set -x
          set -euo pipefail
          snyk test --all --fail-on=${{ inputs.snyk_fail_on }}
      - name: Snyk monitor
        shell: bash
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          set -x
          set -euo pipefail
          snyk monitor --all --project-name="${{ needs.prep.outputs.app_name }}" --project-tags="version=${{ needs.prep.outputs.app_version }}"

  deploy:
    runs-on: ubuntu-latest
    needs: [prep, build, sonar, snyk]
    if: ${{ inputs.run_deploy && github.ref == 'refs/heads/main' }}
    environment: production
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Deploy
        shell: bash
        env:
          DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
          APP_NAME: ${{ needs.prep.outputs.app_name }}
          APP_VERSION: ${{ needs.prep.outputs.app_version }}
        run: ${{ inputs.deploy_cmd }}
