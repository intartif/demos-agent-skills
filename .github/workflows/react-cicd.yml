name: React CI/CD Reusable

description: 'Reusable workflow for CI/CD with conditional jobs'

on:
  workflow_call:
    inputs:
      branch:
        required: true
        type: string
      apply-test:
        required: true
        type: string
      apply-snyk:
        required: true
        type: string
      apply-build:
        required: true
        type: string
      apply-deploy:
        required: true
        type: string
      issue-id:
        required: true
        type: string
      creator:
        required: true
        type: string

jobs:

  assign-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Assign issue and comment (with debug)
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const issueId = parseInt('${{ inputs.issue-id }}', 10);
            const creator = '${{ inputs.creator }}';
            core.info(`Context: ${JSON.stringify(context, null, 2)}`);
            core.info(`typeof github: ${typeof github}`);
            core.info(`github keys: ${Object.keys(github)}`);
            core.info(`typeof github.rest.issues: ${typeof github.rest.issues}`);
            let assignRes, commentRes;
            try {
              assignRes = await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueId,
                assignees: [creator]
              });
              core.info(`Assign response: ${JSON.stringify(assignRes, null, 2)}`);
            } catch (e) {
              core.error(`Error assigning: ${e.message}`);
              core.error(JSON.stringify(e, null, 2));
            }
            try {
              commentRes = await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueId,
                body: `Atención iniciada por @${creator}.`
              });
              core.info(`Comment response: ${JSON.stringify(commentRes, null, 2)}`);
            } catch (e) {
              core.error(`Error commenting: ${e.message}`);
              core.error(JSON.stringify(e, null, 2));
            }

  format:
    runs-on: ubuntu-latest
    needs: assign-issue
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 16
      - run: npm install
      - run: npm run format

  type-check:
    runs-on: ubuntu-latest
    needs: format
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 16
      - run: npm install
      - run: npm run flow

  lint:
    runs-on: ubuntu-latest
    needs: type-check
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 16
      - run: npm install
      - run: npm run lint

  snyk-scan:
    if: ${{ inputs.apply-snyk == 'Sí' }}
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 16
      - run: npm install
      - name: Run Snyk
        uses: snyk/actions/node@v3
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test

  unit-test:
    if: ${{ inputs.apply-test == 'Sí' && (inputs.apply-snyk != 'Sí' || needs.snyk-scan.result == 'success') }}
    needs: [lint, snyk-scan]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 16
      - run: npm install
      - run: npm run unit

  build:
    if: ${{ inputs.apply-build == 'Sí' && (inputs.apply-snyk != 'Sí' || needs.snyk-scan.result == 'success') }}
    needs: [lint, snyk-scan, unit-test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 16
      - run: npm install
      - run: npm run build

  deploy:
    if: ${{ inputs.apply-deploy == 'Sí' && (inputs.apply-snyk != 'Sí' || needs.snyk-scan.result == 'success') }}
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 16
      - run: npm install
      - run: npm run build
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GH_TOKEN }}
          publish_dir: ./build

  update-issue:
    runs-on: ubuntu-latest
    needs:
      - deploy
      - build
      - unit-test
      - snyk-scan
      - lint
      - type-check
      - format
    if: always()
    steps:
      - name: Update issue with result
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const issueId = parseInt('${{ inputs.issue-id }}', 10);
            const jobs = [
              'format', 'type-check', 'lint', 'snyk-scan', 'unit-test', 'build', 'deploy'
            ];
            let failed = false;
            for (const job of jobs) {
              if (process.env[`JOB_${job.toUpperCase()}_RESULT`] === 'failure') {
                failed = true;
                break;
              }
            }
            const message = failed
              ? 'El workflow ha fallado en uno o más jobs.'
              : 'El workflow se completó exitosamente.';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueId,
              body: message
            });
            if (!failed) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueId,
                state: 'closed'
              });
            }
